#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <openssl/md5.h>
#include <openssl/pem.h>
//base64 encode
size_t bc_base64_encode(const void *data, int data_len, char *buffer)
{
    BIO *b64 = BIO_new(BIO_f_base64());
    BIO *bio = BIO_new(BIO_s_mem());

    bio = BIO_push(b64, bio);
    BIO_set_flags(bio, BIO_FLAGS_BASE64_NO_NL);
    BIO_write(bio, data, data_len);
    BIO_ctrl(bio, BIO_CTRL_FLUSH, 0, NULL);

    BUF_MEM *bptr = NULL;
    BIO_get_mem_ptr(bio, &bptr);

    size_t slen = bptr->length;
    memcpy(buffer, bptr->data, slen);
    buffer[slen] = '\0';

    BIO_free_all(bio);
    return slen;
}

//base64 decode
static int base64_decode(char *str,int str_len,char *decode,int decode_buffer_len)
{
    int len=0;
    BIO *b64,*bmem;
    b64=BIO_new(BIO_f_base64());
    bmem=BIO_new_mem_buf(str,str_len);
    bmem=BIO_push(b64,bmem);
    len=BIO_read(bmem,decode,str_len);
    decode[len]=0;
    BIO_free_all(bmem);
    return 0;
}


//string md5
int getStringmd5(char *input,char *output)
{
     char  password[1024*1024*5]={0};
     MD5_CTX x;
     int  i = 0, len;
     char  *out = NULL;
     unsigned  char  d[16];
     unsigned  char  tmp[128] = { 0 }; 
     strcpy (password,input);
     MD5_Init(&x);
     MD5_Update(&x, ( char  *)password,  strlen (password));
     MD5_Final(d, &x);
     out = ( char  *) malloc (35*sizeof(char));
     if(out == NULL) return 0;
	//memset(md5hash,0,hash_size*sizeof(char));
     memset (out, 0x00, 35*sizeof(char));
     strcpy (out,  "$1$" );
    // printf("MD5(\"%s\") = ", password);
     for  (i = 0; i < 16; i++)
     {
         sprintf (out + (i*2),  "%02x" , d[i]);  // 转换为32位
     }
     out[32] = 0;
    // printf("%s\n", out);
     strcpy (output,out);
     free (out);
     return  0;
}

//file_md5
char* fileMd5(char* filename){
	char* file_md5 = (char *)malloc((32 + 1) * sizeof(char));
	memset(file_md5, 0, (32 + 1));
	unsigned char c[MD5_DIGEST_LENGTH];
    //char *filename="file.c";
    int i;
    FILE *inFile = fopen (filename, "rb");
    MD5_CTX mdContext;
    int bytes;
    unsigned char data[1024];

    if (inFile == NULL) {
        printf ("%s can't be opened.\n", filename);
        return 0;
    }

    MD5_Init (&mdContext);
    while ((bytes = fread (data, 1, 1024, inFile)) != 0)
        MD5_Update (&mdContext, data, bytes);
    MD5_Final (c,&mdContext);
    for(i = 0; i < MD5_DIGEST_LENGTH; i++) {
    	sprintf(&file_md5[i*2], "%02x", c[i]);
    }
    fclose (inFile);
    return file_md5;
}
	