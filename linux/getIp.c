#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <netdb.h>
#include <net/if.h>
#include <arpa/inet.h>
#include "httpApi.h"
extern char g_client_ip[64];
char *get_ip()
{
	int fd, num;
	struct ifreq ifq[16];
	struct ifconf ifc;
	int i;
	char *ips, *tmp_ip;
	char *delim = ",";
	int val;
	
	fd = socket(AF_INET, SOCK_DGRAM, 0);
	if(fd < 0)
	{
		fprintf(stderr, "socket failed\n");
		return NULL;
	}
	ifc.ifc_len = sizeof(ifq);
	ifc.ifc_buf = (caddr_t)ifq;
	if(ioctl(fd, SIOCGIFCONF, (char *)&ifc))
	{
		fprintf(stderr, "ioctl failed\n");
		return NULL;
	}
	num = ifc.ifc_len / sizeof(struct ifreq);
	if(ioctl(fd, SIOCGIFADDR, (char *)&ifq[num-1]))
	{
		fprintf(stderr, "ioctl failed\n");
		return NULL;
	}
	close(fd);
	
	val = 0;
	for(i=0; i<num; i++)
	{
		tmp_ip = inet_ntoa(((struct sockaddr_in*)(&ifq[i].ifr_addr))-> sin_addr);
		if(strcmp(tmp_ip, "127.0.0.1") != 0)
		{
			val++;
		}
	}
	
	ips = (char *)malloc(val * 64 * sizeof(char));
	if(ips == NULL)
	{
		fprintf(stderr, "malloc failed\n");
		return NULL;
	}
	memset(ips, 0, val * 64 * sizeof(char));
	val = 0;
	//bug 10.*.10.*
	for(i=0; i<num; i++)
	{
		tmp_ip = inet_ntoa(((struct sockaddr_in*)(&ifq[i].ifr_addr))-> sin_addr);
		if(strcmp(tmp_ip, "127.0.0.1") != 0 && strcmp(tmp_ip, "0.0.0.0") != 0 && strcmp(tmp_ip, "1.1.1.1") != 0)
		{
			char *reg_pattern1 = strstr(tmp_ip,"10."); //去掉
			char *reg_pattern2 = strstr(tmp_ip,".10."); //baoliu
			char *reg_pattern3 = strstr(tmp_ip,"192.168.");
			char *reg_pattern6 = strstr(tmp_ip,".192.168.");
			char *reg_pattern4 = strstr(tmp_ip,"172.");
			char *reg_pattern5 = strstr(tmp_ip,".172.");
			
			if(reg_pattern1!=NULL&&reg_pattern2==NULL){
				continue;
			}
			if(reg_pattern4!=NULL&&reg_pattern5==NULL){
				continue;
			}
			if(reg_pattern3!=NULL&&reg_pattern6==NULL){
				continue;
			}
			if(reg_pattern2!=NULL||reg_pattern5!=NULL||reg_pattern6!=NULL){
				continue;
			}
			if(val > 0){
				strcat(ips, delim);
			}
			strcat(ips, tmp_ip);
			val ++;	
		}
		
	}
	
	//nat
	if(val==0){
		int flag=query_taobaoIpApi();
		if(flag==1){
			strcat(ips,g_client_ip);
			strcat(ips, delim);
			val++;
			for(i=0; i<num; i++)
			{
				tmp_ip = inet_ntoa(((struct sockaddr_in*)(&ifq[i].ifr_addr))-> sin_addr);
				if(strcmp(tmp_ip, "127.0.0.1") != 0 && strcmp(tmp_ip, "0.0.0.0") != 0 && strcmp(tmp_ip, "1.1.1.1") != 0)
				{
					if(val > 0){
						strcat(ips, delim);
					}
					strcat(ips, tmp_ip);
					val ++;	
				}
				
			}
		}else{
			for(i=0; i<num; i++)
			{
				tmp_ip = inet_ntoa(((struct sockaddr_in*)(&ifq[i].ifr_addr))-> sin_addr);
				if(strcmp(tmp_ip, "127.0.0.1") != 0 && strcmp(tmp_ip, "0.0.0.0") != 0 && strcmp(tmp_ip, "1.1.1.1") != 0)
				{
					if(val > 0){
						strcat(ips, delim);
					}
					strcat(ips, tmp_ip);
					val ++;	
				}
				
			}
		}
	}
	
	return ips;
}
