#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dirent.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/types.h>
#include "getIp.h"
#include "httpApi.h"
#include "fileInfo.h"
#include "ssllib.h"
#define MAX_PATH_LENGTH		512
#define MAX_FILE_EXTENSION	9

unsigned long visit_dirs = 0;
unsigned long visit_files = 0;
extern int g_clean_type;
extern char g_virus_path[260];
extern char *g_pass;
extern g_client_ip[64];
int g_c_virusCount=0;
int g_c_packedCount=0;
int g_c_scanCount=0;
int g_c_cleanedCount=0;
extern char g_virus_size[10];
extern char g_virus_hash[50];
extern char g_virus_name[20];
extern char g_blacklist[2];

void listdir(char *path){
	DIR 		*ptr_dir;
	struct dirent 	*dir_entry;
	int 		i = 0;
	char		*child_path;
	char		*file_path;

	child_path = (char*)malloc(sizeof(char)*MAX_PATH_LENGTH);
	if(child_path == NULL){
		printf("allocate memory for path failed.\n");
		return;
	}
	memset(child_path, 0, sizeof(char)*MAX_PATH_LENGTH);

	file_path = (char*)malloc(sizeof(char)*MAX_PATH_LENGTH);
	if(file_path == NULL){
		printf("allocate memory for file path failed.\n");
		free(child_path);
		child_path = NULL;
		return;
	}
	memset(file_path, 0, sizeof(char)*MAX_PATH_LENGTH);

	ptr_dir = opendir(path);
	while((dir_entry = readdir(ptr_dir)) != NULL){
		if(dir_entry->d_type & DT_DIR){
			if(strcmp(dir_entry->d_name,".") == 0 ||
			   strcmp(dir_entry->d_name,"..") == 0){
				continue;
			}
			sprintf(child_path, "%s/%s", path, dir_entry->d_name);
			visit_dirs++;

			listdir(child_path);
		}

		if(dir_entry->d_type & DT_REG){
			sprintf(file_path, "%s/%s", path, dir_entry->d_name);
		//	printf("[FILE]%s\n", file_path);
			///
			int isVirus=getHash(file_path);
			g_c_scanCount++;
			//char *local_ip;
			//local_ip = get_ip();
			char *kill_temp="File Del";
			char *kill_temp2="Del Falied";
			if(isVirus==1){
				g_c_virusCount++;
				int kill_size=60;
				char *kill = malloc(kill_size*(sizeof(char)));
				if(kill == NULL) return 0;
				memset(kill,0,kill_size*sizeof(char));				
				if(g_clean_type==1){
					int delet_file;
					delet_file=remove(g_virus_path);
					if(delet_file==0){
						//kill="File Deleted";
						printf("Virus Deleted\n");
						strncpy(kill,kill_temp,sizeof(kill));
						g_c_cleanedCount++;
					}else{
						//kill="File Deleted Failed";
						strncpy(kill,kill_temp2,sizeof(kill));
					}
				}if(g_clean_type==2){
					printf("It looks like a virus! Clean it ? [Y/N]: ");
					char isClean[5];
					scanf("%s",isClean);
					char *m_y="Y";
					char *n_y="y";
					if (strncmp(isClean,m_y,sizeof(m_y))==0 || strncmp(isClean,n_y,sizeof(n_y))==0){
							int delet_file;
							delet_file=remove(g_virus_path);
							if(delet_file==0){
								//kill="File Deleted";
								strncpy(kill,kill_temp,sizeof(kill));
								printf("Virus Deleted\n");
								g_c_cleanedCount++;
							}else{
								//strncpy(kill,"File Deleted Failed",sizeof(kill));
								strncpy(kill,kill_temp2,sizeof(kill));
							}
						}else{
							strncpy(kill,"not kill",sizeof(kill));
						}
				}
				char virus_id[10];
				sprintf(virus_id,"%d",g_c_scanCount);
				char *start_type="banff_test";
				char buf[60]={""};
				strcat(buf,g_virus_hash);
				strcat(buf,g_pass);
				//char *token=MDString(buf);
				int hash_size=33;
				char *md5hash = malloc(hash_size*(sizeof(char)));
				if(md5hash == NULL) return 0;
				memset(md5hash,0,hash_size*sizeof(char)); //初始化为0
				getStringmd5(buf,md5hash);
				int base64hash_size=1024;
				char *base64hash = malloc(base64hash_size*(sizeof(char)));
				if(base64hash == NULL) return 0;
				memset(base64hash,0,base64hash_size*sizeof(char));
				bc_base64_encode(g_virus_path,strlen(g_virus_path),base64hash);
				insertVirus(g_virus_name,g_virus_hash,g_virus_size,base64hash,"",g_client_ip,kill,virus_id,start_type,md5hash);
				//insertVirus(g_virus_name,g_virus_hash,g_virus_size,g_virus_path,"",local_ip,kill);
				free(kill);
				free(md5hash);
				free(base64hash);
			}
			if(isVirus==2){
				int kill2_size=20;
				char *kill2 = malloc(kill2_size*(sizeof(char)));
				if(kill2 == NULL) return 0;
				memset(kill2,0,kill2_size*sizeof(char));
				g_c_packedCount++;
				//char *local_ip;
				//local_ip = get_ip();
				char *file_md5=fileMd5(g_virus_path);
				printf("It looks like a virus! Clean it ? [Y/N]: ");
				char isClean[10];
				scanf("%s",isClean);
				char *m_y="Y";
				char *n_y="y";
				if (strncmp(isClean,m_y,sizeof(m_y))==0 || strncmp(isClean,n_y,sizeof(n_y))==0){
						int delet_file2;
						delet_file2=remove(g_virus_path);
						if(delet_file2==0){
							//kill2="File Deleted";
							strncpy(kill2,kill_temp,sizeof(kill2));
							printf("File Deleted\n");
							g_c_cleanedCount++;
						}else{
							//kill2="File Deleted Failed";
							//strncpy(kill2,"File Deleted Failed",sizeof(kill2));
							strncpy(kill2,kill_temp2,sizeof(kill2));
						}

					}else{
						//kill2="not kill";
						strncpy(kill2,"not kill",sizeof(kill2));
					}
				char virus_id[10];
				sprintf(virus_id,"%d",g_c_scanCount);
				char *start_type="banff_test";
				char buf[60]={""};
				strcat(buf,g_virus_hash);
				strcat(buf,g_pass);
				//char *token=MDString(buf);
				int hash_size=33;
				char *md5hash = malloc(hash_size*(sizeof(char)));
				if(md5hash == NULL) return 0;
				memset(md5hash,0,hash_size*sizeof(char)); //初始化为0
				getStringmd5(buf,md5hash);
				int base64hash_size=1024;
				char *base64hash = malloc(base64hash_size*(sizeof(char)));
				if(base64hash == NULL) return 0;
				memset(base64hash,0,base64hash_size*sizeof(char));
				bc_base64_encode(g_virus_path,strlen(g_virus_path),base64hash);
				insertVirus("Unknow Elf",file_md5,"0",base64hash,"",g_client_ip,kill2,virus_id,start_type,md5hash);
				//insertVirus("Unknow Elf",file_md5,"0",g_virus_path,"",local_ip,kill2);
				free(kill2);
				free(md5hash);
				free(file_md5);
				free(base64hash);
			}
			//free(local_ip);
			//return 1;
		}
			visit_files++;
	}
	

	free(child_path);
	child_path = NULL;

	free(file_path);
	file_path = NULL;
}


int customScan(char *path){
	listdir(path);
}